---
title: "Untitled"
author: "Caitie"
date: "2024-03-03"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r}
library(tidyverse)
library(sf)
library(raster)
library(terra)
library(here)
library(tmap)
library(biscale)
#library(ggsflabel)
```

```{r}
t_crs<- "EPSG:3460"
```

# Fiji tikinas
```{r}
fiji<-st_read(here("input_data/Fiji/fji_polbnda_adm3_tikina.shp")) %>% 
    st_make_valid(.) %>%
  st_transform(., t_crs)


fiji_tik<-fiji %>% 
  mutate(diss = 1) %>% 
  group_by(ADM3_NAME) %>% 
  summarise(diss = sum(diss)) %>% 
  mutate(prov_area_km2 = as.numeric(st_area(.)*1e-6))

fiji_prov<-fiji %>% 
  mutate(diss = 1) %>% 
  group_by(ADM2_NAME) %>% 
  summarise(diss = sum(diss)) %>% 
  mutate(prov_area_km2 = as.numeric(st_area(.)*1e-6)) %>% 
  filter(ADM2_NAME %in% c("Ba", "Ra", "Macuata", "Bua"))
  

poi<-fiji %>% 
  filter(ADM2_NAME %in% c("Ba", "Ra", "Macuata", "Bua"))

```


#Indices created by Diego

```{r}
#index<-st_read(here("input_data/Index/Climate_Threat_index.shp")) %>% 
  
index<-st_read(here("input_data/TotalIndex1.shp"))%>%
  dplyr::select(ADM3_NA, THEMES, Th_A) %>% 
  st_transform(., t_crs) %>% 
  rename(Local_threats = Th_A,
         Climate_vul = THEMES)
```

# Separate out into categories

```{r}
bi_data <- bi_class(index, x = Local_threats, y = Climate_vul, style = "quantile", dim = 3)
```

```{r}
map_watershed <- ggplot() +
  geom_sf(data = bi_data, mapping = aes(fill = bi_class), color = "white", size = 0.1, show.legend = FALSE) +
  bi_scale_fill(pal = "GrPink", dim = 3) +
  bi_theme() +
  geom_sf(data = fiji_prov, colour="goldenrod1", fill=NA, lwd = 0.5) #+
 # geom_sf_label_repel(data = fiji_prov, aes(label = ADM2_NAME), vjust = -1.5, hjust = 1.5) 

map_watershed
```


```{r}
legend_watersheds <- bi_legend(pal = "GrPink",
                    dim = 3,
                    xlab = "Non-climate threats",
                    ylab = "Climate vulnerability",
                    size = 8)
```

```{r}
finalPlot_watersheds <- ggdraw() +
  draw_plot(map_watershed, 0, 0, 1, 1) +
  draw_plot(legend_watersheds, 0.2, .5, 0.3, 0.3)

finalPlot_watersheds
```

```{r}
ggsave(here("figures/Vul_threat_bivariate_level9.png"), finalPlot_watersheds, width = 10, height = 10)
```

# Subset to Provinces of interest


```{r}
index_sub<-st_read(here("input_data/TotalIndex_sel1.shp"))%>%
  #filter(ADM2_NA %in% c("Ba", "Ra", "Bua", "Macuata")) %>%
  dplyr::select(ADM2_NA, ADM3_NA, THEMES, Th_A) %>% 
  st_transform(., t_crs) %>% 
  rename(Local_threats = Th_A,
         Climate_vul = THEMES)
```
```{r}
bi_data_sub <- bi_class(index_sub, x = Local_threats, y = Climate_vul, style = "quantile", dim = 3)
```
 # Need to change the ones that are outlined in yellow
 
```{r}
map_watershed_sub <- ggplot() +
  geom_sf(data = bi_data_sub, mapping = aes(fill = bi_class), color = "white", size = 0.1, show.legend = FALSE) +
  bi_scale_fill(pal = "GrPink", dim = 3) +
  bi_theme() +
  geom_sf(data = fiji_prov, colour="goldenrod1", fill=NA, lwd = 0.5) #+
 # geom_sf_label_repel(data = fiji_prov, aes(label = ADM2_NAME), vjust = -1.5, hjust = 1.5) 

map_watershed_sub
```

```{r}
ggsave(here("figures/Vul_threat_bivariate_level9_toi.png"), finalPlot_watersheds_poi, width = 10, height = 10)
```

# Save a shapefile or csv of the priority ADM2 and ADM3 names for other mapping
